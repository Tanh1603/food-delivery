log_format upstreamlog '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'upstream: $upstream_addr, '
                        'response_time: $upstream_response_time, '
                        'request_time: $request_time';

access_log /var/log/nginx/access.log upstreamlog;

upstream api_backend {
  # Load balancing algorithm
  ${LB_ALGO};
  
  # Backend servers
  server api-1:3000 weight=1 max_fails=3 fail_timeout=30s;
  server api-2:3000 weight=1 max_fails=3 fail_timeout=30s;
  server api-3:3000 weight=1 max_fails=3 fail_timeout=30s;

  # Keepalive connections
  keepalive 32;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

server {
  listen 80;
  server_name localhost;

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;

  # Logging
  access_log /var/log/nginx/access.log upstreamlog;
  error_log /var/log/nginx/error.log warn;

  # Client settings
  client_max_body_size 10M;
  client_body_buffer_size 128k;

  # Timeouts
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;
  send_timeout 60s;

  # Buffers
  proxy_buffer_size 4k;
  proxy_buffers 8 4k;
  proxy_busy_buffers_size 8k;

  # Health check endpoint (nginx itself)
  location = /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }

  # Nginx status (for monitoring)
  location = /nginx-status {
    stub_status on;
    access_log off;
    allow 172.28.0.0/16;
    deny all;
  }

  # Backend health checks - NO RATE LIMITING
  # IMPORTANT: These must come BEFORE /api/ location
  location = /api/health {
    access_log off;
    proxy_pass http://api_backend/api/health;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Add upstream info for debugging
    add_header X-Upstream-Server $upstream_addr always;
  }

  location = /api/ready {
    access_log off;
    proxy_pass http://api_backend/api/ready;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location = /api/live {
    access_log off;
    proxy_pass http://api_backend/api/live;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location = /api/info {
    access_log off;
    proxy_pass http://api_backend/api/info;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  # API endpoints with rate limiting
  # location /api/ {
  #   # Rate limiting
  #   limit_req zone=api_limit burst=20 nodelay;
  #   limit_req_status 429;

  #   # Proxy to backend
  #   proxy_pass http://api_backend;

  #   # Headers
  #   proxy_set_header Host $host;
  #   proxy_set_header X-Real-IP $remote_addr;
  #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header X-Forwarded-Proto $scheme;
  #   proxy_set_header X-Request-ID $request_id;

  #   # Load balancer info headers
  #   add_header X-Upstream-Server $upstream_addr always;
  #   add_header X-Upstream-Response-Time $upstream_response_time always;
  #   add_header X-Request-ID $request_id always;

  #   # Keepalive
  #   proxy_http_version 1.1;
  #   proxy_set_header Connection "";

  #   # Error handling
  #   proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
  #   proxy_next_upstream_tries 2;
  #   proxy_next_upstream_timeout 10s;

  #   # CORS headers
  #   add_header Access-Control-Allow-Origin * always;
  #   add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
  #   add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-ID" always;

  #   # Handle OPTIONS for CORS preflight
  #   if ($request_method = 'OPTIONS') {
  #     add_header Access-Control-Allow-Origin * always;
  #     add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
  #     add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-ID" always;
  #     add_header Access-Control-Max-Age 3600;
  #     add_header Content-Length 0;
  #     add_header Content-Type text/plain;
  #     return 204;
  #   }
  # }


location /api/ {
    # Proxy to backend
    proxy_pass http://api_backend;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;

    # Load balancer info headers
    add_header X-Upstream-Server $upstream_addr always;
    add_header X-Upstream-Response-Time $upstream_response_time always;
    add_header X-Request-ID $request_id always;

    # Keepalive
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Error handling
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    proxy_next_upstream_tries 2;
    proxy_next_upstream_timeout 10s;

    # CORS headers
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-ID" always;

    # Handle OPTIONS for CORS preflight
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-ID" always;
      add_header Access-Control-Max-Age 3600;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
}

  # Error pages
  error_page 502 503 504 /50x.html;
  location = /50x.html {
    return 503 '{"error":"Service unavailable"}';
    add_header Content-Type application/json;
  }

  error_page 429 /429.html;
  location = /429.html {
    return 429 '{"error":"Too many requests"}';
    add_header Content-Type application/json;
  }
}
